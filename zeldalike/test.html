<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.20.0/dist/phaser.js"></script>
        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">
            var config = {
            type: Phaser.AUTO,
            width: 1000, height: 800,
            pixelArt: true,
            
            physics: {
                default: 'arcade',
                arcade: {
                
                debug: true
            }},


            scene: {preload: preload, create: create, update: update }
            };
            
            new Phaser.Game(config);
            function preload(){
            this.load.image('sky', 'assets/sky.png');
            this.load.image('ground', 'assets/platform.png');
            
            

            this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");
            this.load.tilemapTiledJSON("carte", "map.json");  
            
            this.load.spritesheet('perso','assets/perso2.png',
            { frameWidth: 24, frameHeight: 27 });
            this.load.spritesheet('bullet','assets/fireShot.png',
            { frameWidth: 32, frameHeight: 32 });
            }

            var platforms;
            var block;
            var player;
            var facing = 0;

            var speed = 200;//vitesse de déplacement
            var tpSpeed = speed*4//vitesse du tp 
            var tpLenght = 18000 //distance de tp
            var frame = 20;

            var dash = 0;

            /*
            var bullets;
            var lastFired = 0;
            var isDown = false;
            */
            
            
            var gameOver;
            gameOver = false;

            function create(){
                //_______________________________________
                //_____________TERRAIN___________________
                //_______________________________________
                
                /*
                this.add.image(400, 300, 'sky');

                platforms = this.physics.add.staticGroup();
                platforms.create(400, 568, 'ground').setScale(2).refreshBody();
                platforms.create(600, 400, 'ground');
                platforms.create(50, 260, 'ground');
                platforms.create(750, 230, 'ground');
                */
                

                

                const carteDuNiveau = this.add.tilemap("carte");

                const tileset = carteDuNiveau.addTilesetImage(
                "tuiles-de-jeu",
                "Phaser_tuilesdejeu"
                );  

                const block = carteDuNiveau.createStaticLayer(
                "block",
                tileset
                );

                const sol = carteDuNiveau.createStaticLayer(
                "sol",
                tileset
                );

                const deco = carteDuNiveau.createStaticLayer(
                "deco",
                tileset
                );

                

                
                block.setCollisionByProperty({ estSolide: true }); 


                //_______________________________________
                //_____________OBJET_____________________
                //_______________________________________

                var Bullet = new Phaser.Class({
                    Extends: Phaser.GameObjects.Image

                });
                
                player = this.physics.add.sprite(100, 200, 'perso').setSize(15 ,10).setOffset(5, 17)   ;
                // reglage de la hitbox du perso

                player.setCollideWorldBounds(true);
                this.physics.add.collider(player, platforms);
                
                this.physics.add.collider(player, block);
                this.physics.world.setBounds(0, 0, 1000, 1000);
                this.cameras.main.setBounds(0, 0, 1000, 1000);
                this.cameras.main.startFollow(player);
                this.cameras.main.zoom=2;

                
                //_______________________________________
                //_____________ANIMATION_________________
                //_______________________________________

                this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('perso', {start:30,end:39}),
                frameRate: frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn left',
                frames: this.anims.generateFrameNumbers('perso', {start:20,end:23}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp left',
                frames: this.anims.generateFrameNumbers('perso', {start:24,end:27}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'down',
                frames: this.anims.generateFrameNumbers('perso', {start:10,end:19}),
                frameRate: frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn down',
                frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp down',
                frames: this.anims.generateFrameNumbers('perso', {start:4,end:7}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'up',
                frames: this.anims.generateFrameNumbers('perso', {start:50,end:59}),
                frameRate: frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn up',
                frames: this.anims.generateFrameNumbers('perso', {start:40,end:43}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp up',
                frames: this.anims.generateFrameNumbers('perso', {start:44,end:47}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('perso', {start:70,end:79}),
                frameRate: frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn right',
                frames: this.anims.generateFrameNumbers('perso', {start:60,end:63}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp right',
                frames: this.anims.generateFrameNumbers('perso', {start:64,end:67}),
                frameRate: 20,
                
                });



                cursors = this.input.keyboard.createCursorKeys();

                //_______________________________________
                //_______________________________________

                debug=this.add.text(300,160,'Facing: 0',{fontSize:'32px',fill:'#000'});
                //Phaser.Display.Align.In.TopLeft(debug,cameras);
                //affiche un texte à l’écran, pour le score

                



            }
            function update(){
                if (gameOver){return;}
                debug.setText('Facing: ' + facing); //met à jour l’affichage du texte

                //_______________________________________
                //_____________DASH_______________
                //_______________________________________

                if ((this.input.keyboard.checkDown(cursors.space,tpLenght)==true)&&(dash==0)){dash=tpLenght};
                if (dash>0){
                    dash = dash -tpSpeed
                    if (facing==0){
                        player.setVelocityY(tpSpeed);
                        player.setVelocityX(0);
                        player.anims.play('tp down', true);
                    }
                    else if (facing == 1){
                        player.setVelocityX(-tpSpeed);
                        player.setVelocityY(0);
                        player.anims.play('tp left', true);
                    }
                    else if (facing == 2){
                        player.setVelocityY(-tpSpeed);
                        player.setVelocityX(0);
                        player.anims.play('tp up', true);
                    }
                    else if (facing == 3){
                        player.setVelocityX(tpSpeed);
                        player.setVelocityY(0);
                        player.anims.play('tp right', true);
                    }
                };
                if (dash<0){dash = 0};
                
                //_______________________________________
                //_____________DEPLACEMENT_______________
                //_______________________________________
                if(dash==0){

                    if (cursors.left.isDown){ //si la touche gauche est appuyée
                        facing = 1;
                        if (player.body.velocity.y!=0){
                            player.setVelocityX(-speed/1.5);
                        }
                        else {
                            player.setVelocityX(-speed);
                            
                        
                        } //alors vitesse négative en X
                        if((!cursors.up.isDown)&&(!cursors.down.isDown)){player.anims.play('left', true);} //et animation => gauche
                        

                        }
                    
                    else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
                        facing = 3;
                        if (player.body.velocity.y!=0){
                            player.setVelocityX(speed/1.5);
                        }
                        else {
                            player.setVelocityX(speed);//alors vitesse positive en X
                            
                        } 
                        if((!cursors.up.isDown)&&(!cursors.down.isDown)){player.anims.play('right', true);} //et animation => droite
                        
                    }

                    else{ // sinon
                    player.setVelocityX(0); //vitesse nulle
                    }

                    if (cursors.up.isDown){//si touche haut appuyée 
                        facing = 2;
                        if (player.body.velocity.x!=0){
                            player.setVelocityY(-speed/1.5);
                        }
                        else {player.setVelocityY(-speed);}
                        //alors vitesse verticale négative
                        player.anims.play('up', true);//animation haut
                    }
                    else if (cursors.down.isDown){ //sinon si la touche bas est appuyée
                        facing = 0;
                        if (player.body.velocity.x!=0){
                            player.setVelocityY(speed/1.5);
                        }
                        else {player.setVelocityY(speed);}
                        //alors vitesse verticale positive
                        player.anims.play('down', true); //animation bas
                    
                    }
                    else{ // sinon
                    player.setVelocityY(0); //vitesse nulle
                    }
                    if ((player.body.velocity.x==0)&&(player.body.velocity.y==0)){
                        if(facing == 0){player.anims.play('turn down',true);}
                        else if (facing == 1){player.anims.play('turn left',true);}
                        else if (facing == 2){player.anims.play('turn up',true);}
                        else if (facing == 3){player.anims.play('turn right',true);}
                    }

                }
                
            }
            




        </script>
    </body>
</html>