<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.20.0/dist/phaser.js"></script>
        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">
            class sceneExemple extends Phaser.Scene{
                constructor(){
                super("sceneExemple");
                }

            
            preload(){
           

            this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");
            this.load.tilemapTiledJSON("carte", "map.json");  
            
            this.load.spritesheet('perso','assets/perso2.png',
            { frameWidth: 24, frameHeight: 27 });
            this.load.spritesheet('bullet','assets/fireShot.png',
            { frameWidth: 32, frameHeight: 32 });
            this.load.spritesheet('bullet','assets/monstre.png',
            { frameWidth: 30 , frameHeight: 30 });


            }

            create(){
                //_______________________________________
                //_____________TERRAIN___________________
                //_______________________________________
                

                const carteDuNiveau = this.add.tilemap("carte");

                const tileset = carteDuNiveau.addTilesetImage(
                "tuiles-de-jeu",
                "Phaser_tuilesdejeu"
                );  

                const block = carteDuNiveau.createStaticLayer(
                "block",
                tileset
                );

                const sol = carteDuNiveau.createStaticLayer(
                "sol",
                tileset
                );

                const deco = carteDuNiveau.createStaticLayer(
                "deco",
                tileset
                );

                

                
                block.setCollisionByProperty({ estSolide: true }); 


                //_______________________________________
                //_____________OBJET_____________________
                //_______________________________________

                this.facing = 0;
                this.frame = 20;//vitesse animation 

                
                this.speed = 200;//vitesse de déplacement
                this.tpSpeed = this.speed*4//vitesse du tp 
                this.tpLenght = 18000 //distance de tp

                this.dash = 0;
                this.maxCharge = 6;//nombre max d'utilisation du dash
                this.charge = this.maxCharge; 
                
                this.player = this.physics.add.sprite(800, 500, 'perso').setSize(15 ,10).setOffset(5, 17);
                
                // reglage de la hitbox du perso

                this.player.setCollideWorldBounds(true);
                
                
                this.physics.add.collider(this.player, block);
                this.physics.world.setBounds(0, 0, 1000, 1000);
                this.cameras.main.setBounds(0, 0, 1000, 1000);
                this.cameras.main.startFollow(this.player);
                this.cameras.main.zoom=2;

                
                //_______________________________________
                //_____________ANIMATION_________________
                //_______________________________________

                this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('perso', {start:30,end:39}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn left',
                frames: this.anims.generateFrameNumbers('perso', {start:20,end:23}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp left',
                frames: this.anims.generateFrameNumbers('perso', {start:24,end:27}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'down',
                frames: this.anims.generateFrameNumbers('perso', {start:10,end:19}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn down',
                frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp down',
                frames: this.anims.generateFrameNumbers('perso', {start:4,end:7}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'up',
                frames: this.anims.generateFrameNumbers('perso', {start:50,end:59}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn up',
                frames: this.anims.generateFrameNumbers('perso', {start:40,end:43}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp up',
                frames: this.anims.generateFrameNumbers('perso', {start:44,end:47}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('perso', {start:70,end:79}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn right',
                frames: this.anims.generateFrameNumbers('perso', {start:60,end:63}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp right',
                frames: this.anims.generateFrameNumbers('perso', {start:64,end:67}),
                frameRate: 20,
                
                });

                this.cursors = this.input.keyboard.createCursorKeys();

                //_______________________________________
                //_______________________________________

                this.debug=this.add.text(260,200,'Dash: 0',{fontSize:'28px',fill:'#000'}).setScrollFactor(0);
                //affiche un texte à l’écran, pour le score

                



            }
            update(){
                
                this.debug.setText('Dash: ' + this.charge); //met à jour l’affichage du texte

                //_______________________________________
                //_____________DASH_______________
                //_______________________________________

                if ((this.input.keyboard.checkDown(this.cursors.space,this.tpLenght)==true)&&(this.dash==0)&&(this.charge>0)){this.dash=this.tpLenght,this.charge-=1};
                if (this.dash>0){
                    this.dash -= this.tpSpeed
                    if (this.facing==0){
                        this.player.setVelocityY(this.tpSpeed);
                        this.player.setVelocityX(0);
                        this.player.anims.play('tp down', true);
                    }
                    else if (this.facing == 1){
                        this.player.setVelocityX(-this.tpSpeed);
                        this.player.setVelocityY(0);
                        this.player.anims.play('tp left', true);
                    }
                    else if (this.facing == 2){
                        this.player.setVelocityY(-this.tpSpeed);
                        this.player.setVelocityX(0);
                        this.player.anims.play('tp up', true);
                    }
                    else if (this.facing == 3){
                        this.player.setVelocityX(this.tpSpeed);
                        this.player.setVelocityY(0);
                        this.player.anims.play('tp right', true);
                    }
                };
                if (this.dash<0){this.dash = 0};
                
                //_______________________________________
                //_____________DEPLACEMENT_______________
                //_______________________________________
                if(this.dash==0){

                    if (this.cursors.left.isDown){ //si la touche gauche est appuyée
                        this.facing = 1;
                        if (this.player.body.velocity.y!=0){
                            this.player.setVelocityX(-this.speed/1.5);
                        }
                        else {
                            this.player.setVelocityX(-this.speed);
                            
                        
                        } //alors vitesse négative en X
                        if((!this.cursors.up.isDown)&&(!this.cursors.down.isDown)){this.player.anims.play('left', true);} //et animation => gauche
                        

                        }
                    
                    else if (this.cursors.right.isDown){ //sinon si la touche droite est appuyée
                        this.facing = 3;
                        if (this.player.body.velocity.y!=0){
                            this.player.setVelocityX(this.speed/1.5);
                        }
                        else {
                            this.player.setVelocityX(this.speed);//alors vitesse positive en X
                            
                        } 
                        if((!this.cursors.up.isDown)&&(!this.cursors.down.isDown)){this.player.anims.play('right', true);} //et animation => droite
                        
                    }

                    else{ // sinon
                        this.player.setVelocityX(0); //vitesse nulle
                    }

                    if (this.cursors.up.isDown){//si touche haut appuyée 
                        this.facing = 2;
                        if (this.player.body.velocity.x!=0){
                            this.player.setVelocityY(-this.speed/1.5);
                        }
                        else {this.player.setVelocityY(-this.speed);}
                        //alors vitesse verticale négative
                        this.player.anims.play('up', true);//animation haut
                    }
                    else if (this.cursors.down.isDown){ //sinon si la touche bas est appuyée
                        this.facing = 0;
                        if (this.player.body.velocity.x!=0){
                            this.player.setVelocityY(this.speed/1.5);
                        }
                        else {this.player.setVelocityY(this.speed);}
                        //alors vitesse verticale positive
                        this.player.anims.play('down', true); //animation bas
                    
                    }
                    else{ // sinon
                        this.player.setVelocityY(0); //vitesse nulle
                    }
                    if ((this.player.body.velocity.x==0)&&(this.player.body.velocity.y==0)){
                        if(this.facing == 0){this.player.anims.play('turn down',true);}
                        else if (this.facing == 1){this.player.anims.play('turn left',true);}
                        else if (this.facing == 2){this.player.anims.play('turn up',true);}
                        else if (this.facing == 3){this.player.anims.play('turn right',true);}
                    }

                }
                
            }
        }
            var config = {
            type: Phaser.AUTO,
            width: 1000, height: 800,
            pixelArt: true,
            
            physics: {
                default: 'arcade',
                arcade: {
                
                debug: true
            }},


            scene:[sceneExemple]
            };
            
            new Phaser.Game(config);
            




        </script>
    </body>
</html>