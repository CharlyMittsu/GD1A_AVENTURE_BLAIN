<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Candle</title>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.20.0/dist/phaser.js"></script>
        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">
            class sceneExemple extends Phaser.Scene{
                constructor(){
                super("sceneExemple");
                }

            
            preload(){
           

            this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");
            this.load.tilemapTiledJSON("carte", "map.json");  
            
            this.load.spritesheet('perso','assets/perso2.png',
            { frameWidth: 24, frameHeight: 30 });
            this.load.spritesheet('bullet','assets/fireShot1.png',
            { frameWidth: 32, frameHeight: 32 });
            this.load.spritesheet('arbreMonstre','assets/monstre.png',
            { frameWidth: 30 , frameHeight: 30 });
            this.load.spritesheet('energie','assets/energieParticle.png',
            { frameWidth: 7 , frameHeight: 7 });
            this.load.spritesheet('energi3','assets/energi3Particle.png',
            { frameWidth: 12, frameHeight: 12 });
            this.load.spritesheet('bush','assets/bush.png',
            { frameWidth: 32 , frameHeight: 32 });
            this.load.spritesheet('rocher','assets/rocher.png',
            { frameWidth: 64 , frameHeight: 32 });
            this.load.spritesheet('lock','assets/lock.png',
            { frameWidth: 64 , frameHeight: 32 });
            this.load.spritesheet('arbre','assets/arbre.png',
            { frameWidth: 96 , frameHeight: 96 });

            this.load.spritesheet('energieBar','assets/energieBar.png',
            { frameWidth: 256 , frameHeight: 64 });
            this.load.spritesheet('blockEye','assets/blockEye.png',
            { frameWidth: 32 , frameHeight: 32 });
            this.load.spritesheet('flambeau','assets/flambeau.png',
            { frameWidth: 32 , frameHeight: 32 });
            this.load.spritesheet('beacon','assets/beacon.png',
            { frameWidth: 16 , frameHeight: 32 });
            this.load.spritesheet('number','assets/number.png',
            { frameWidth: 16 , frameHeight: 8 });
            this.load.spritesheet('bougie','assets/bougie.png',
            { frameWidth: 32 , frameHeight: 64 });
            this.load.spritesheet('pressA','assets/pressA.png',
            { frameWidth: 64 , frameHeight: 16 });
            this.load.image('focus','assets/focus.png',
            { frameWidth: 1 , frameHeight: 1 });
            this.load.image('keys','assets/key.png',
            { frameWidth: 16 , frameHeight: 16 });


            }

            create(){
                //_______________________________________
                //_____________LOAD TERRAIN______________
                //_______________________________________
                

                const carteDuNiveau = this.make.tilemap({key:"carte"});

                const tileset = carteDuNiveau.addTilesetImage(
                "tuiles-de-jeu",
                "Phaser_tuilesdejeu"
                );  

                //_______________________________________
                //_________TUILES SOUS LE JOUEUR_________
                //_______________________________________

                const sol = carteDuNiveau.createStaticLayer(
                "sol",
                tileset
                );

                const block = carteDuNiveau.createStaticLayer(//tuiles Solides
                "block",
                tileset
                );
                const trou = carteDuNiveau.createStaticLayer(//tuiles Solides
                "trou",
                tileset
                );
                

                const deco = carteDuNiveau.createStaticLayer(
                "deco",
                tileset
                );

                //_______________________________________
                //__________CREATION OBJET_______________
                //_______________________________________

                this.energies = this.physics.add.group({
                    key: 'energie',
                    immovable: true,

                });
                this.energi3s = this.physics.add.group({
                    key: 'energi3',
                    immovable: true,

                });
                this.bullets = this.physics.add.group({
                    key: 'bullet',
                    

                });
                this.bushs = this.physics.add.group({
                    key: 'bush',
                    immovable: true,

                });
                
                this.rochers = this.physics.add.group({
                    key: 'rocher',
                    immovable: true,
                    

                });
                this.locks = this.physics.add.group({
                    key: 'lock',
                    immovable: true,
                    

                });
                
                this.arbres = this.physics.add.group({
                    key: 'arbre',
                    immovable: true,
                    

                });
                this.arbreMonstres = this.physics.add.group({
                    key: 'arbreMonstre',
                    
                });
                
                this.burningMonstres = this.physics.add.group({
                    key: 'burningMonstre',
                    
                });
                this.blockEyes = this.physics.add.group({
                    key: 'blockEye',
                    immovable: true,
                    
                });
                this.flambeauOffs = this.physics.add.group({
                    key: 'flambeauOffs',
                    immovable: true,
                    
                });
                this.flambeauOns = this.physics.add.group({
                    key: 'flambeauOns',
                    immovable: true,
                    
                });
                this.beacons = this.physics.add.group({
                    key: 'beacon',
                    immovable: true,
                    
                });
                
                this.numbers = this.physics.add.group({
                    key: 'number',

                });
                this.focus = this.physics.add.group({
                    key: 'focus',
                    
                });
                this.keys = this.physics.add.group({
                    key: 'keys',
                    
                });
                
                

                carteDuNiveau.getObjectLayer('energieCalque').objects.forEach((energie)=>{
                    const energieSprite = this.energies.create(energie.x,energie.y-energie.height,'energie').setOrigin(0);
                });
                carteDuNiveau.getObjectLayer('energi3Calque').objects.forEach((energi3)=>{
                    const energi3Sprite = this.energi3s.create(energi3.x,energi3.y-energi3.height,'energi3').setOrigin(0);
                });
                carteDuNiveau.getObjectLayer('bushCalque').objects.forEach((bush)=>{
                    const bushSprite = this.bushs.create(bush.x,bush.y-bush.height,'bush').setOrigin(0);
                });
                
                carteDuNiveau.getObjectLayer('monstreCalque').objects.forEach((arbreMonstre)=>{
                    const arbreMonstreSprite = this.arbreMonstres.create(arbreMonstre.x,arbreMonstre.y-arbreMonstre.height,'arbreMonstre').setOrigin(0);
                });
                carteDuNiveau.getObjectLayer('blockEyeCalque').objects.forEach((blockEye)=>{
                    const blockEyeSprite = this.blockEyes.create(blockEye.x,blockEye.y-blockEye.height,'blockEye').setOrigin(0);
                });
                carteDuNiveau.getObjectLayer('rocherCalque').objects.forEach((rocher)=>{
                    const rocherSprite = this.rochers.create(rocher.x,rocher.y-rocher.height,'rocher').setOrigin(0).setSize(64 ,10).setOffset(5, 22);
                });
                carteDuNiveau.getObjectLayer('lockCalque').objects.forEach((lock)=>{
                    const lockSprite = this.locks.create(lock.x,lock.y-lock.height,'lock').setOrigin(0);
                });
                carteDuNiveau.getObjectLayer('arbreCalque').objects.forEach((arbre)=>{
                    const arbreSprite = this.arbres.create(arbre.x-32,arbre.y-96,'arbre').setOrigin(0).setSize(16 ,10).setOffset(40, 86);
                });
                carteDuNiveau.getObjectLayer('flambeauCalque').objects.forEach((flambeau)=>{
                    const rocherSprite = this.flambeauOffs.create(flambeau.x,flambeau.y-flambeau.height,'flambeau').setOrigin(0);
                })
                carteDuNiveau.getObjectLayer('beaconCalque').objects.forEach((beacon)=>{
                    const rocherSprite = this.beacons.create(beacon.x+16,beacon.y-32,'beacon').setOrigin(0).setSize(8 ,10).setOffset(4, 22);
                })
                

                //_______________________________________
                //_______________JOUEUR__________________
                //_______________________________________

                this.player = this.physics.add.sprite(1148, 1600, 'perso').setSize(15 ,10).setOffset(5, 17).setDepth(1);// reglage de la hitbox du perso
                //affichage du perso entre ces calques

                //_______________________________________
                //_________TUILES SUR LE JOUEUR__________
                //_______________________________________

                const deco2 = carteDuNiveau.createStaticLayer(
                "deco2",
                tileset
                ).setDepth(2);

                
                block.setCollisionByProperty({ estSolide: true }); 
                trou.setCollisionByProperty({ estSolide: true }); 


                //_______________________________________
                //______________VARIABLES________________
                //_______________________________________


                this.facing = 0;
                this.frame = 20;//vitesse animation 
                this.cinematic=false;
                this.mobsKilled=false;
                this.keyGet=true;
                this.porteOuverte = false;

                
                this.speed0 = 200;//vitesse de déplacement de base
                this.speed=this.speed0

                this.tpSpeed = this.speed*4//vitesse du tp 
                this.tpLenght = 15000 //distance de tp

                this.maxPv = 3;
                this.pv = 1;
                this.dash = 0;//dash inactif si 0
                this.maxCharge = 6;//nombre max d'utilisation du dash
                this.charge = this.maxCharge; 
                this.dashOn=true;//si le dash est débloqué
                this.fireOn=true;//si le tir est débloqué
                this.maxChargeFire = 10;
                this.chargeFire = this.maxChargeFire;
                this.buffEnergie = true;// si on a le bonus pour 12 charge de dash

                this.bulletSpeed = this.speed+this.speed0
                this.bulletSpread = 20; //disperion du tir

                this.keyE = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);
                this.keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
                
                
                
                //_______________________________________
                //______________PHYSIQUE_________________
                //_______________________________________

                

                this.player.setCollideWorldBounds(true);// le perso ne peu sortir des limites du terrain
                
                this.physics.add.collider(this.player, block);//le perso est blocker par les tuiles block(estSolide)
                this.physics.add.collider( this.player,trou);//ne peut pas passer au dessus des trou
                this.physics.add.collider(this.player, this.rochers, this.rocherHit, null, this);
                this.physics.add.collider(this.player, this.locks, this.unlock, null, this);//par les portes
                this.physics.add.collider(this.player, this.arbres);
                this.physics.add.collider( this.player,this.flambeauOffs, this.lightFlambeau, null, this);
                this.physics.add.collider(this.player, this.beacons);
                this.physics.add.collider( this.player,this.flambeauOns,this.hitFlambeau, null, this);
                this.physics.add.collider( this.player,this.blockEyes,this.collideBlockEye,null,this);
                
                this.physics.add.collider( this.bullets,block, this.collideBullet, null, this);//collision du fireshot avec les murs etc
                this.physics.add.collider( this.bullets,this.rochers, this.collideBullet, null, this);
                this.physics.add.collider( this.bullets,this.locks, this.collideBullet, null, this);
                this.physics.add.collider( this.bullets,this.blockEyes, this.collideBullet, null, this);
                this.physics.add.collider( this.bullets,this.arbres, this.collideBullet, null, this);
                this.physics.add.collider( this.bullets,this.beacons, this.collideBullet,this.tpPlayer, null, this);

                this.physics.add.collider( this.arbreMonstres,block);
                this.physics.add.collider( this.arbreMonstres,this.rochers);
                this.physics.add.collider( this.arbreMonstres,this.locks);
                this.physics.add.collider( this.arbreMonstres,this.arbreMonstres);
                this.physics.add.collider( this.arbreMonstres,this.flambeauOns);
                this.physics.add.collider( this.arbreMonstres,this.flambeauOffs);
                this.physics.add.collider( this.arbreMonstres,this.beacons);
                this.physics.add.collider( this.arbreMonstres,this.blockEyes,this.collideBlockEye,null,this);
                this.physics.add.collider( this.arbreMonstres,trou);//ne peut pas passer au dessus des trou
                this.physics.add.collider(this.arbreMonstres, this.arbres);
                
                this.physics.add.collider(this.blockEyes, this.arbres);
                this.physics.add.collider( this.blockEyes,this.rochers);
                this.physics.add.collider( this.blockEyes,this.beacons);
                this.physics.add.collider( this.blockEyes,block);//ne peut pas passer sur les murs
                this.physics.add.collider( this.blockEyes,trou);//ne peut pas passer au dessus des trou
                
                
                this.physics.world.setBounds(0, 0, 4096, 4096);
                this.cameras.main.setBounds(0, 0, 4096, 4096);

                
                //this.cameraDolly = new Phaser.Geom.Point(this.player.x, this.player.y);//crée un objet que la caméra va suivre
                this.cameras.main.startFollow(this.player);//this.cameraDolly
                this.cameras.main.zoom=2;

                
                

                
                
                this.physics.add.overlap(this.player, this.energies, this.hitEnergie, null, this);
                this.physics.add.overlap(this.player, this.energi3s, this.hitEnergi3, null, this);
                this.physics.add.overlap(this.bullets, this.bushs, this.burnBush, null, this);
                this.physics.add.overlap( this.bullets,this.flambeauOffs,this.lightFlambeau,  null, this);
                this.physics.add.overlap(this.player, this.bushs, this.burnBush, null, this);
                this.physics.add.overlap(this.player, this.arbreMonstres, this.burnArbreMonstre, null, this);
                this.physics.add.overlap(this.bullets, this.arbreMonstres, this.burnArbreMonstre, null, this);
                
                //this.physics.add.overlap(this.keys, this.focusKey, this.stopCinematic, null, this);


                
                //_______________________________________
                //_____________ANIMATION_________________
                //_______________________________________

                //animation perso
                this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('perso', {start:30,end:39}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn left',
                frames: this.anims.generateFrameNumbers('perso', {start:20,end:23}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp left',
                frames: this.anims.generateFrameNumbers('perso', {start:24,end:27}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'down',
                frames: this.anims.generateFrameNumbers('perso', {start:10,end:19}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn down',
                frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp down',
                frames: this.anims.generateFrameNumbers('perso', {start:4,end:7}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'up',
                frames: this.anims.generateFrameNumbers('perso', {start:50,end:59}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn up',
                frames: this.anims.generateFrameNumbers('perso', {start:40,end:43}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp up',
                frames: this.anims.generateFrameNumbers('perso', {start:44,end:47}),
                frameRate: 20,
                
                });
                this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('perso', {start:70,end:79}),
                frameRate: this.frame,
                repeat: -1
                });
                this.anims.create({
                key: 'turn right',
                frames: this.anims.generateFrameNumbers('perso', {start:60,end:63}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'tp right',
                frames: this.anims.generateFrameNumbers('perso', {start:64,end:67}),
                frameRate: 20,
                
                });


                //animation objet______________________________
                this.anims.create({
                key: 'idleBullet',
                frames: this.anims.generateFrameNumbers('bullet', {start:0,end:7}),
                frameRate: 20,
                repeat: -1
                });
                this.anims.create({
                key: 'burningBush',
                frames: this.anims.generateFrameNumbers('bush', {start:1,end:4}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: 'idleEnergie',
                frames: this.anims.generateFrameNumbers('energie', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
                });
                this.anims.create({
                key: 'idleEnergi3',
                frames: this.anims.generateFrameNumbers('energi3', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
                });

                //animation monstre______________________________
                this.anims.create({
                key: 'turnArbreMonstre',
                frames: this.anims.generateFrameNumbers('arbreMonstre', {start:8,end:9}),
                frameRate: 2,
                repeat: -1
                });
                this.anims.create({
                key: 'rightArbreMonstre',
                frames: this.anims.generateFrameNumbers('arbreMonstre', {start:0,end:3}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: 'leftArbreMonstre',
                frames: this.anims.generateFrameNumbers('arbreMonstre', {start:4,end:7}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: 'burningArbreMonstre',
                frames: this.anims.generateFrameNumbers('arbreMonstre', {start:12,end:15}),
                frameRate: 10,
                repeat: -1
                });

                this.anims.create({
                key: 'turnOff',
                frames: [ { key: 'flambeau', frame: 0 } ],
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: 'turnOn',
                frames: this.anims.generateFrameNumbers('flambeau', {start:1,end:4}),
                frameRate: 10,
                repeat: -1
                });

                this.anims.create({
                key: 'eyeClose',
                frames: [ { key: 'blockEye', frame: 0 } ],
                
                });
                this.anims.create({
                key: 'eyeOpen',
                frames: [ { key: 'blockEye', frame: 1 } ],
                
                });
                //animation ui bougie__________________________________
                this.anims.create({
                key: '3PV',
                frames: this.anims.generateFrameNumbers('bougie', {start:0,end:3}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: '2PV',
                frames: this.anims.generateFrameNumbers('bougie', {start:4,end:7}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: '1PV',
                frames: this.anims.generateFrameNumbers('bougie', {start:8,end:11}),
                frameRate: 10,
                repeat: -1
                });
                
                //animation ui barre___________________________________

                this.anims.create({
                key: 'pressA',
                frames: this.anims.generateFrameNumbers('pressA', {start:0,end:5}),
                frameRate: 10,
                repeat: -1
                });
                this.anims.create({
                key: 'noPressA',
                frames: [ { key: 'pressA', frame: 6 } ],
                });
                
                
                this.anims.create({
                key: 'E0/6',
                frames: [ { key: 'energieBar', frame: 0 } ],
                });
                this.anims.create({
                key: 'E1/6',
                frames: [ { key: 'energieBar', frame: 1 } ],
                });
                this.anims.create({
                key: 'E2/6',
                frames: [ { key: 'energieBar', frame: 2 } ],
                });
                this.anims.create({
                key: 'E3/6',
                frames: [ { key: 'energieBar', frame: 3 } ],
                });
                this.anims.create({
                key: 'E4/6',
                frames: [ { key: 'energieBar', frame: 4 } ],
                });
                this.anims.create({
                key: 'E5/6',
                frames: [ { key: 'energieBar', frame: 5 } ],
                });
                this.anims.create({
                key: 'E6/6',
                frames: [ { key: 'energieBar', frame: 6 } ],
                });
                this.anims.create({
                key: 'E0/12',
                frames: [ { key: 'energieBar', frame: 7 } ],
                });
                this.anims.create({
                key: 'E1/12',
                frames: [ { key: 'energieBar', frame: 8 } ],
                });
                this.anims.create({
                key: 'E2/12',
                frames: [ { key: 'energieBar', frame: 9 } ],
                });
                this.anims.create({
                key: 'E3/12',
                frames: [ { key: 'energieBar', frame: 10 } ],
                });
                this.anims.create({
                key: 'E4/12',
                frames: [ { key: 'energieBar', frame: 11 } ],
                });
                this.anims.create({
                key: 'E5/12',
                frames: [ { key: 'energieBar', frame: 12 } ],
                });
                this.anims.create({
                key: 'E6/12',
                frames: [ { key: 'energieBar', frame: 13 } ],
                });
                this.anims.create({
                key: 'E7/12',
                frames: [ { key: 'energieBar', frame: 14 } ],
                });
                this.anims.create({
                key: 'E8/12',
                frames: [ { key: 'energieBar', frame: 15 } ],
                });
                this.anims.create({
                key: 'E9/12',
                frames: [ { key: 'energieBar', frame: 16 } ],
                });
                this.anims.create({
                key: 'E10/12',
                frames: [ { key: 'energieBar', frame: 17 } ],
                });
                this.anims.create({
                key: 'E11/12',
                frames: [ { key: 'energieBar', frame: 18 } ],
                });
                this.anims.create({
                key: 'E12/12',
                frames: [ { key: 'energieBar', frame: 19 } ],
                });
                this.anims.create({
                key: 'nullBar',
                frames: [ { key: 'energieBar', frame: 20 } ],
                });

                this.cursors = this.input.keyboard.createCursorKeys();

                //animation number_______________________
                this.anims.create({ key: '0',frames: [ { key: 'number', frame: 0 } ],});
                this.anims.create({ key: '1',frames: [ { key: 'number', frame: 1 } ],});
                this.anims.create({ key: '2',frames: [ { key: 'number', frame: 2 } ],});
                this.anims.create({ key: '3',frames: [ { key: 'number', frame: 3 } ],});
                this.anims.create({ key: '4',frames: [ { key: 'number', frame: 4 } ],});
                this.anims.create({ key: '5',frames: [ { key: 'number', frame: 5 } ],});
                this.anims.create({ key: '6',frames: [ { key: 'number', frame: 6 } ],});
                this.anims.create({ key: '7',frames: [ { key: 'number', frame: 7 } ],});
                this.anims.create({ key: '8',frames: [ { key: 'number', frame: 8 } ],});
                this.anims.create({ key: '9',frames: [ { key: 'number', frame: 9 } ],});
                this.anims.create({ key: '10',frames: [ { key: 'number', frame: 10 } ],});
                this.anims.create({ key: '11',frames: [ { key: 'number', frame: 11 } ],});
                this.anims.create({ key: '12',frames: [ { key: 'number', frame: 12 } ],});
                this.anims.create({ key: '13',frames: [ { key: 'number', frame: 13 } ],});
                this.anims.create({ key: '14',frames: [ { key: 'number', frame: 14 } ],});
                this.anims.create({ key: '15',frames: [ { key: 'number', frame: 15 } ],});
                this.anims.create({ key: '16',frames: [ { key: 'number', frame: 16 } ],});
                this.anims.create({ key: '17',frames: [ { key: 'number', frame: 17 } ],});
                this.anims.create({ key: '18',frames: [ { key: 'number', frame: 18 } ],});
                this.anims.create({ key: '19',frames: [ { key: 'number', frame: 19} ],});
               
                
                
                
                //_______________________________________
                //_______________________________________

                
                this.energieBar=this.add.sprite(450,228,'energieBar').setScrollFactor(0).setDepth(3);
                //affiche un texte à l’écran, pour le score
                this.bougie=this.add.sprite(350,220,'bougie').setScrollFactor(0).setDepth(3);
                this.pressA=this.add.sprite(400,210,'pressA').setScrollFactor(0).setDepth(3);
                this.focusKey=this.focus.create(this.player.body.x-20,this.player.body.y-20,'focus');


                



            }
            //_______________________________________
            //________________UPDATE_________________
            //_______________________________________
            update(){
                var info = this.add.sprite()
                this.focusKey.body.x = this.player.body.x-20;
                this.focusKey.body.y = this.player.body.y-20;
                

                this.updateSpeed();
                if (this.buffEnergie == false&&this.dashOn==true){this.maxCharge = 6 }else if(this.buffEnergie == true &&this.dashOn==true) {this.maxCharge = 12}else{this.maxCharge = 0};
                //console.log(this.maxCharge)
                
                
                this.updateBougie(this.pv);
                this.updateEnergieBar(this.charge);
                if(this.pv<this.maxPv&&this.charge>=6&&this.dashOn==true){this.pressA.anims.play('pressA',true)}else{this.pressA.anims.play('noPressA',true)}

                //recharge tir
                if(this.chargeFire<=0 && this.charge>0 && this.fireOn==true){this.setCharge(-1);this.chargeFire=this.maxChargeFire}
                //console.log(this.chargeFire)

                this.monstresRestant= -1;
                this.flambeausRestant = -1;

                //_______________________________________
                //___________PROFONDEUR_________________
                //_______________________________________

                this.rochers.children.iterate(function (rocher) {
                    var Y =rocher.scene.player.body.y
                    if (rocher.body.y>Y){
                        rocher.setDepth(2)
                        //console.log("true")
                    }
                    else if(rocher.body.y<=Y) {
                        rocher.setDepth(0)
                        //console.log("false")
                    }
                });
                this.beacons.children.iterate(function (beacon) {
                    var Y =beacon.scene.player.body.y
                    if (beacon.body.y>Y){
                        beacon.setDepth(2)
                        //console.log("true")
                    }
                    else if(beacon.body.y<=Y) {
                        beacon.setDepth(0)
                        //console.log("false")
                    }
                });
                this.arbres.children.iterate(function (arbre) {
                    var Y =arbre.scene.player.body.y
                    if (arbre.body.y>Y){
                        arbre.setDepth(2)
                        //console.log("true")
                    }
                    else if(arbre.body.y<=Y) {
                        arbre.setDepth(0)
                        //console.log("false")
                    }
                });
                //_______________________________________
                //___________NUMBER MOVE_________________
                //_______________________________________
                this.numbers.children.iterate(function (nombre) {
                    
                    if (nombre.body.velocity.y<0){nombre.body.velocity.y+=1}else{nombre.destroy()}
                },this);//,this pour utiliser les this.physics dans une fonction

                //_______________________________________
                //__________FLAMBEAU COUNT_______________
                //_______________________________________
                this.flambeauOffs.children.iterate(function (flambeau) {
                    this.flambeausRestant += 1;
                },this);//,this pour utiliser les this.physics dans une fonction
                

                //_______________________________________
                //____________ENNEMY COUNT_______________
                //_______________________________________
                
                this.arbreMonstres.children.iterate(function (arbreMonstre) {//pour chaque arbreMonstre enfant du groupe arbreMonstres

                    this.monstresRestant+=1;
                },this);

                if(this.monstresRestant==0&&this.mobsKilled==false){
                    this.mobsKilled=true;
                    this.keyGet=true;
                    this.cinematic=true;
                    this.keys.create(this.player.body.x-20,this.player.body.y-400,'keys')
                    console.log('clé obtenue')
                }

                
                if(this.cinematic==false){//tout les deplacement sont faisable si une cinematique n'est pas en cours

                    
                    //_______________________________________
                    //______________KEY MOVE_________________
                    //_______________________________________
                
                    this.keys.children.iterate(function (keys) {//la clé suit le point à coté du joueur
                    var distanceKey = Phaser.Math.Distance.Between(keys.scene.focusKey.body.x,keys.scene.focusKey.body.y,keys.body.x,keys.body.y)
                    if (distanceKey>800)keys.destroy()
                    else if(distanceKey>15){this.physics.moveToObject(keys, keys.scene.focusKey, this.speed*(distanceKey/30) );}
                    else{keys.setVelocity(0)}
                    if(this.porteOuverte==true)keys.destroy()
                    },this);

                
                    
                    //_______________________________________
                    //__________ENNEMY ARBRE MOVE____________
                    //_______________________________________
                    
                    this.arbreMonstres.children.iterate(function (arbreMonstre) {//pour chaque arbreMonstre enfant du groupe arbreMonstres

                        
                        if(Phaser.Math.Distance.Between(arbreMonstre.scene.player.body.x,arbreMonstre.scene.player.body.y,arbreMonstre.body.x,arbreMonstre.body.y)<150) {
                                
                                this.physics.moveToObject(arbreMonstre, arbreMonstre.scene.player, -arbreMonstre.scene.speed*0.7);
                                
                            if(arbreMonstre.body.velocity.x>0) {arbreMonstre.anims.play('rightArbreMonstre',true);}else{arbreMonstre.anims.play('leftArbreMonstre',true);}
                                    
                                    
                        }else{//si il n'y a pas de joueur autour du monstre
                            if(arbreMonstre.body.velocity.x>0) {arbreMonstre.setVelocityX(arbreMonstre.body.velocity.x-2);}else{arbreMonstre.setVelocityX(0) }
                            if(arbreMonstre.body.velocity.y>0) {arbreMonstre.setVelocityY(arbreMonstre.body.velocity.y-2);}else{arbreMonstre.setVelocityY(0) }
                            if((arbreMonstre.body.velocity.y==0)&&(arbreMonstre.body.velocity.x==0) ){arbreMonstre.anims.play('turnArbreMonstre',true);}
                        }
                    },this);
                    //console.log("monstres restant : ",this.monstresRestant);
                    
                    //_______________________________________
                    //__________BLOCKEYE MOVE____________
                    //_______________________________________
                    
                    this.blockEyes.children.iterate(function (blockEye) {//pour chaque blockEye enfant du groupe blockEyes
                        var dist =Phaser.Math.Distance.Between(blockEye.scene.player.body.x,blockEye.scene.player.body.y,blockEye.body.x,blockEye.body.y)
                        if ((blockEye.body.x>blockEye.scene.player.body.x+30)||(blockEye.body.x<blockEye.scene.player.body.x-30) ){
                            var speed = blockEye.scene.speed*(dist/40)
                        }else{var speed = blockEye.scene.speed}
                        if (blockEye.scene.player.body.velocity.y == 0){speed = speed} else { speed = speed/1.5;}
                        
                        if(dist<160&&blockEye.scene.dash<=blockEye.scene.tpLenght*0.4){//le monstre ne detecte pas le joueur au debut du dash
                            blockEye.anims.play('eyeOpen',true);
                            if(blockEye.scene.player.body.x<blockEye.body.x+10)blockEye.setVelocityX(-speed)//va à gauche si le joueur à gauche
                            else if (blockEye.scene.player.body.x>blockEye.body.x+10)blockEye.setVelocityX(speed)
                            else blockEye.setVelocityX(0)
                            if ((blockEye.body.x+10>blockEye.scene.player.body.x)&&(blockEye.body.x+10<blockEye.scene.player.body.x+2)||(blockEye.body.x+10<blockEye.scene.player.body.x)&&(blockEye.body.x+10>blockEye.scene.player.body.x-2) ){
                                blockEye.body.x=blockEye.scene.player.body.x-10
                            }
                        }
                        else{
                            blockEye.anims.play('eyeClose',true);
                            blockEye.setVelocityX(0)
                        }
                    });

                    //_______________________________________
                    //__________ENERGIE MOVE_________________
                    //_______________________________________
                    this.energies.children.iterate(function (energie) {
                    
                        energie.anims.play('idleEnergie',true);
                        var dist =Phaser.Math.Distance.Between(energie.scene.player.body.x,energie.scene.player.body.y,energie.body.x,energie.body.y)
                        if (dist<500){
                            this.physics.moveToObject(energie, energie.scene.player, 500/(dist/20));
                            
                            
                        }
                        
                    },this);//,this pour utiliser les this.physics dans une fonction

                    this.energi3s.children.iterate(function (energie) {
                        
                        energie.anims.play('idleEnergi3',true);
                        var dist =Phaser.Math.Distance.Between(energie.scene.player.body.x,energie.scene.player.body.y,energie.body.x,energie.body.y)
                        if (dist<500){
                            this.physics.moveToObject(energie, energie.scene.player, 500/(dist/20));
                            
                        }
                        
                    },this);//,this pour utiliser les this.physics dans une fonction

                    

                    
                    
                    //_______________________________________
                    //_____________DASH_______________
                    //_______________________________________

                    if ((this.input.keyboard.checkDown(this.cursors.space,this.tpLenght)==true)&&(this.dash==0)&&(this.charge>0)&&(this.dashOn==true) ){this.dash=this.tpLenght,this.setCharge(-1)};
                    if (this.dash>0){
                        this.dash -= this.tpSpeed
                        if (this.facing==0){
                            this.player.setVelocityY(this.tpSpeed);
                            this.player.setVelocityX(0);
                            this.player.anims.play('tp down', true);
                        }
                        else if (this.facing == 1){
                            this.player.setVelocityX(-this.tpSpeed);
                            this.player.setVelocityY(0);
                            this.player.anims.play('tp left', true);
                        }
                        else if (this.facing == 2){
                            this.player.setVelocityY(-this.tpSpeed);
                            this.player.setVelocityX(0);
                            this.player.anims.play('tp up', true);
                        }
                        else if (this.facing == 3){
                            this.player.setVelocityX(this.tpSpeed);
                            this.player.setVelocityY(0);
                            this.player.anims.play('tp right', true);
                        }
                    };
                    if (this.dash<0){this.dash = 0};



                    if (this.input.keyboard.checkDown(this.keyA,200)==true&&this.pv!=this.maxPv&&this.charge>=6){
                        this.setCharge(-6);
                        this.setPV(1);
                    };
                    if (this.input.keyboard.checkDown(this.keyE,200)==true&&this.fireOn==true){this.createBullet(this.player.x,this.player.y)};
                    //this.input.keyboard.checkDown(this.cursors.space,500)==true)
                    //this.keyE.isDown
                    //_______________________________________
                    //_____________DEPLACEMENT_______________
                    //_______________________________________
                    if(this.dash==0){

                        if (this.cursors.left.isDown){ //si la touche gauche est appuyée
                            this.facing = 1;
                            if (this.player.body.velocity.y!=0){
                                this.player.setVelocityX(-this.speed/1.5);
                            }
                            else {
                                this.player.setVelocityX(-this.speed);
                                
                            
                            } //alors vitesse négative en X
                            if((!this.cursors.up.isDown)&&(!this.cursors.down.isDown)){this.player.anims.play('left', true);} // si on avance pas en haut ou en bas animation => gauche
                            

                            }
                        
                        else if (this.cursors.right.isDown){ //sinon si la touche droite est appuyée
                            this.facing = 3;
                            if (this.player.body.velocity.y!=0){
                                this.player.setVelocityX(this.speed/1.5);
                            }
                            else {
                                this.player.setVelocityX(this.speed);//alors vitesse positive en X
                                
                            } 
                            if((!this.cursors.up.isDown)&&(!this.cursors.down.isDown)){this.player.anims.play('right', true);} //et animation => droite
                            
                        }

                        else{ // sinon
                            this.player.setVelocityX(0); //vitesse nulle
                        }

                        if (this.cursors.up.isDown){//si touche haut appuyée 
                            this.facing = 2;
                            if (this.player.body.velocity.x!=0){
                                this.player.setVelocityY(-this.speed/1.5);
                            }
                            else {this.player.setVelocityY(-this.speed);}
                            //alors vitesse verticale négative
                            this.player.anims.play('up', true);//animation haut
                        }
                        else if (this.cursors.down.isDown){ //sinon si la touche bas est appuyée
                            this.facing = 0;
                            if (this.player.body.velocity.x!=0){
                                this.player.setVelocityY(this.speed/1.5);
                            }
                            else {this.player.setVelocityY(this.speed);}
                            //alors vitesse verticale positive
                            this.player.anims.play('down', true); //animation bas
                        
                        }
                        else{ // sinon
                            this.player.setVelocityY(0); //vitesse nulle
                        }
                        if ((this.player.body.velocity.x==0)&&(this.player.body.velocity.y==0)){
                            if(this.facing == 0){this.player.anims.play('turn down',true);}
                            else if (this.facing == 1){this.player.anims.play('turn left',true);}
                            else if (this.facing == 2){this.player.anims.play('turn up',true);}
                            else if (this.facing == 3){this.player.anims.play('turn right',true);}
                        }

                    }
                }else{//si une cinematique est en cours
                    
                    this.dash =0;
                    this.player.setVelocity(0);
                    this.facing=0;
                    this.player.anims.play('turn down',true)
                    this.arbreMonstres.children.iterate(function (arbreMonstre) {arbreMonstre.setVelocity(0)},this);
                    //this.blockEyes.children.iterate(function (blockEye) {blockEye.setVelocity(0)},this);
                    this.bullets.children.iterate(function (bullet) {bullet.destroy()},this);
                    this.energies.children.iterate(function (energie) {energie.setVelocity(0)},this);
                    this.energi3s.children.iterate(function (energi3) {energi3.setVelocity(0)},this);

                    this.keys.children.iterate(function (keys) {//la clé descend du ciel pendant la cinematique
                        var distanceKey = Phaser.Math.Distance.Between(keys.scene.focusKey.body.x,keys.scene.focusKey.body.y,keys.body.x,keys.body.y)
                        this.physics.moveToObject(keys, keys.scene.focusKey, this.speed*(distanceKey/50) );
                        if(distanceKey<15)this.cinematic=false
                        
                        
                    },this);
                
                }
                
                
            }


            
            //_______________________________________
            //____________FIN UPDATE_________________
            //_______________________________________

            //_______________________________________
            //____________FONCTIONS__________________
            //_______________________________________

            updateSpeed(){//fonction pour mettre à jour la vitesse du perso
                this.speed = (this.speed0+0)
            }
            setPV(value){
                
                this.pv += value;
                if (this.pv>this.maxPv){this.pv=this.maxPv}
                if (this.pv<0){this.pv=0}
            }
            updateBougie(value){
                if(value!=0);{
                    
                    if (value==1){this.bougie.anims.play('1PV',true);}
                    if (value==2){this.bougie.anims.play('2PV',true);}
                    if (value==3){this.bougie.anims.play('3PV',true);}
                };

            }

            updateEnergieBar(value){
                if(this.dashOn){
                    if (this.buffEnergie == false){
                    if (value==0){this.energieBar.anims.play('E0/6',true);}
                    if (value==1){this.energieBar.anims.play('E1/6',true);}
                    if (value==2){this.energieBar.anims.play('E2/6',true);}
                    if (value==3){this.energieBar.anims.play('E3/6',true);}
                    if (value==4){this.energieBar.anims.play('E4/6',true);}
                    if (value==5){this.energieBar.anims.play('E5/6',true);}
                    if (value==6){this.energieBar.anims.play('E6/6',true);}
                    }else{
                        if (value==0){this.energieBar.anims.play('E0/12',true);}
                        if (value==1){this.energieBar.anims.play('E1/12',true);}
                        if (value==2){this.energieBar.anims.play('E2/12',true);}
                        if (value==3){this.energieBar.anims.play('E3/12',true);}
                        if (value==4){this.energieBar.anims.play('E4/12',true);}
                        if (value==5){this.energieBar.anims.play('E5/12',true);}
                        if (value==6){this.energieBar.anims.play('E6/12',true);}
                        if (value==7){this.energieBar.anims.play('E7/12',true);}
                        if (value==8){this.energieBar.anims.play('E8/12',true);}
                        if (value==9){this.energieBar.anims.play('E9/12',true);}
                        if (value==10){this.energieBar.anims.play('E10/12',true);}
                        if (value==11){this.energieBar.anims.play('E11/12',true);}
                        if (value==12){this.energieBar.anims.play('E12/12',true);}
                    }
                }else{{this.energieBar.anims.play('nullBar',true);}}

            }
            
            setCharge(value){
                this.charge += value;
                if (this.charge>this.maxCharge){this.charge=this.maxCharge}
                if (this.charge<0){this.charge=0}
            }
            
            hitEnergie(player,energie){
                energie.destroy();//l'energie disparait
                this.setCharge(1);//+1 charge

                
            }
            hitEnergi3(player,energi3){
                energi3.destroy();//l'energi3 disparait
                this.setCharge(3);//+3 charge

            }
            hitFlambeau(player,energi3){
                
                this.setCharge(1);//+3 charge

            }
            
            burnBush(bullet, bush){
                bush.anims.play('burningBush',true)
                setTimeout(function(){
                    bush.destroy()
                    var alea=Phaser.Math.Between(0,150);
                    console.log("burn");
                    
                    if (alea<2&&this.dashOn==true){
                        this.energies.create(bush.x, bush.y, 'energie').setOrigin(0);console.log("success");
                        
                    
                    }
                    

                }.bind(this), 1500);//bind(this) permet d' identifier this.energies
            }
            burnArbreMonstre(player, monstre){
                console.log("monstre tué");
                monstre.destroy();//detruit le monstre
                monstre = this.burningMonstres.create(monstre.x, monstre.y, 'arbreMonstre').setOrigin(0);//remplace le monstre par un monstre en feu
                monstre.anims.play('burningArbreMonstre',true)
                this.createNumber(monstre,this.monstresRestant)
                
                
                setTimeout(function(){
                    monstre.destroy()
                    console.log("cadavre detruit");
                    
                    if (Phaser.Math.Between(0,100)<50){this.energi3s.create(monstre.x, monstre.y, 'energi3').setOrigin(0);}
                    

                }.bind(this), 2000);
                
            }
            rocherHit(player,rocher){
                if (this.dash>0){
                    rocher.destroy();
                    this.cameras.main.shake(250, 0.005);
                }
                //le rocher est detruit si un dash est actif
                

            }
            unlock(player,lock){
                if (this.keyGet==true){
                    lock.destroy();
                    console.log("porte ouverte")
                    this.porteOuverte = true;

                    
                }
                //la porte s'ouvre si on a la clé
                

            }
            stopCinematic(player,lock){
                this.cinematic=false;
                

            }
            
            
            
            createBullet(playerX,playerY){
                if(this.chargeFire>0){
                    this.bullet = this.bullets.create(playerX,playerY,'bullet');
                    
                    if (this.facing==0){
                        this.bullet.setVelocity(Phaser.Math.Between(-this.bulletSpread, this.bulletSpread),this.bulletSpeed);
                        this.bullet.anims.play('idleBullet',true)
                    }
                    else if (this.facing == 1){
                        this.bullet.setVelocity(-this.bulletSpeed,Phaser.Math.Between(-this.bulletSpread, this.bulletSpread));
                        this.bullet.anims.play('idleBullet',true)
                    }
                    else if (this.facing == 2){
                        this.bullet.setVelocity(Phaser.Math.Between(-this.bulletSpread, this.bulletSpread),-this.bulletSpeed);
                        this.bullet.anims.play('idleBullet',true)
                    }
                    else if (this.facing == 3){
                        this.bullet.setVelocity(this.bulletSpeed,Phaser.Math.Between(-this.bulletSpread, this.bulletSpread));
                        this.bullet.anims.play('idleBullet',true)
                    }
                    this.chargeFire -=1;
                }
                
            }
            tpPlayer(bullet,beacon){
                bullet.scene.player.body.x=bullet.body.x+10;
                bullet.scene.player.body.y=bullet.body.y+19;
            }
            collideBullet(bullet){
                bullet.destroy();
            }
            
            lightFlambeau(player, flambeau){
                console.log("flambeau allumé ");
                flambeau.destroy();//detruit le monstre
                var flambeauOn = this.flambeauOns.create(flambeau.x, flambeau.y, 'flambeau').setOrigin(0);//remplace le monstre par un monstre en feu
                flambeauOn.anims.play('turnOn',true);
                this.createNumber(flambeau,this.flambeausRestant)
                
            }
            
            collideBlockEye(player,blockEye){
                if ((player.body.y-5<blockEye.body.y)&&(player.body.y-5>blockEye.body.y-15) ){player.body.y-=32}
                else if ((player.body.y>blockEye.body.y)&&(player.body.y<blockEye.body.y+32) ){player.body.y+=32}
            }
            createNumber(object,value){
                
                this.numbers.children.iterate(function (number) {
                    
                    number.destroy();
                },this);//detruire les autres nombres
                var number = this.numbers.create(object.x+(object.width/2),object.y,'number');
                number.setVelocityY(-100);
                value -=1
                
                number.anims.play(value,true);
                console.log(value)
                
                
            }

            
            //_______________________________________
            //__________FIN FONCTIONS________________
            //_______________________________________
        }
            const config = {
            type: Phaser.AUTO,
            width: 1280, height: 720,
            pixelArt: true,
            //roundPixels: true,
            
            physics: {
                default: 'arcade',
                arcade: {
                
                debug: true
            }},


            scene:[sceneExemple]
            };
            
            new Phaser.Game(config);
            




        </script>
    </body>
</html>